<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Ball-in-Court">
    <title>Ball-in-Court Task Manager</title>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect } = React;

// Simple SVG icons
const Icons = {
  Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  Calendar: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
  User: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
  Clock: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
  Trash: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
  Send: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
  Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
  List: () => <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
  Flame: () => <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>,
  TrendUp: () => <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
  Alert: () => <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
  Archive: () => <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>,
  Users: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
  Mail: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>,
  Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
  Upload: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
  Settings: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m-8.66-9.66l5.2 3m4.92 2.84l5.2 3M1 12h6m6 0h6M3.34 19.66l5.2-3m4.92-2.84l5.2-3"/></svg>,
  UserPlus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
  Grip: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>,
};

const App = () => {
  const [tasks, setTasks] = useState(() => {
    const saved = localStorage.getItem('ballInCourtTasks');
    return saved ? JSON.parse(saved) : [];
  });
  
  const [contacts, setContacts] = useState(() => {
    const saved = localStorage.getItem('ballInCourtContacts');
    return saved ? JSON.parse(saved) : [];
  });
  
  const [activeView, setActiveView] = useState('all');
  const [showAddTask, setShowAddTask] = useState(false);
  const [showHandoff, setShowHandoff] = useState(null);
  const [showSettings, setShowSettings] = useState(false);
  const [showContactManager, setShowContactManager] = useState(false);
  const [showSubtasks, setShowSubtasks] = useState(null);
  const [newTask, setNewTask] = useState({ title: '', dueDate: '', urgency: 'medium', owner: 'Me' });
  const [newContact, setNewContact] = useState({ name: '', email: '' });
  const [newSubtask, setNewSubtask] = useState('');
  const [draggedTask, setDraggedTask] = useState(null);

  useEffect(() => { localStorage.setItem('ballInCourtTasks', JSON.stringify(tasks)); }, [tasks]);
  useEffect(() => { localStorage.setItem('ballInCourtContacts', JSON.stringify(contacts)); }, [contacts]);

  const getToday = () => { const d = new Date(); d.setHours(0,0,0,0); return d; };
  const addDays = (date, days) => { const r = new Date(date); r.setDate(r.getDate() + days); return r; };
  const parseDate = (s) => { if (!s) return null; const d = new Date(s); d.setHours(0,0,0,0); return d; };

  const handleAddTask = () => {
    if (!newTask.title.trim()) return;
    setTasks([...tasks, { id: Date.now(), ...newTask, createdAt: new Date().toISOString(), status: 'active', subtasks: [], order: tasks.length }]);
    setNewTask({ title: '', dueDate: '', urgency: 'medium', owner: 'Me' });
    setShowAddTask(false);
  };

  const handleHandoff = (taskId, data) => {
    const followUpDate = data.followUpDate || addDays(getToday(), 2).toISOString().split('T')[0];
    setTasks(tasks.map(t => t.id === taskId ? { ...t, owner: data.owner, ownerEmail: data.ownerEmail, urgency: data.urgency, dueDate: data.dueDate, followUpDate, handoffDate: new Date().toISOString(), status: 'handed-off' } : t));
    setShowHandoff(null);
  };

  const deleteTask = (id) => { if (confirm('Delete this task?')) setTasks(tasks.filter(t => t.id !== id)); };
  const completeTask = (id) => { setTasks(tasks.map(t => t.id === id ? { ...t, status: 'completed', completedDate: new Date().toISOString() } : t)); };
  
  const addSubtask = (taskId) => {
    const inputValue = subtaskInputs[taskId] || '';
    if (!inputValue.trim()) return;
    setTasks(tasks.map(t => t.id === taskId ? { ...t, subtasks: [...(t.subtasks || []), { id: Date.now(), title: inputValue, completed: false }] } : t));
    setSubtaskInputs({ ...subtaskInputs, [taskId]: '' });
  };

  const toggleSubtask = (taskId, subtaskId) => {
    setTasks(tasks.map(t => t.id === taskId ? { ...t, subtasks: t.subtasks.map(st => st.id === subtaskId ? { ...st, completed: !st.completed } : st) } : t));
  };

  const deleteSubtask = (taskId, subtaskId) => {
    setTasks(tasks.map(t => t.id === taskId ? { ...t, subtasks: t.subtasks.filter(st => st.id !== subtaskId) } : t));
  };

  const promoteSubtask = (taskId, subtask) => {
    const parentTask = tasks.find(t => t.id === taskId);
    const newTask = {
      id: Date.now(),
      title: subtask.title,
      dueDate: parentTask.dueDate,
      urgency: parentTask.urgency,
      owner: parentTask.owner,
      createdAt: new Date().toISOString(),
      status: 'active',
      subtasks: [],
      order: tasks.length
    };
    setTasks([...tasks.map(t => t.id === taskId ? { ...t, subtasks: t.subtasks.filter(st => st.id !== subtask.id) } : t), newTask]);
  };
  
  const handleDragStart = (e, task) => {
    setDraggedTask(task);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  };

  const handleDrop = (e, targetTask) => {
    e.preventDefault();
    if (!draggedTask || draggedTask.id === targetTask.id) return;
    
    const draggedIndex = tasks.findIndex(t => t.id === draggedTask.id);
    const targetIndex = tasks.findIndex(t => t.id === targetTask.id);
    
    const newTasks = [...tasks];
    newTasks.splice(draggedIndex, 1);
    newTasks.splice(targetIndex, 0, draggedTask);
    
    setTasks(newTasks.map((t, idx) => ({ ...t, order: idx })));
    setDraggedTask(null);
  };
  
  const addContact = () => { if (!newContact.name.trim()) return; setContacts([...contacts, { id: Date.now(), ...newContact }]); setNewContact({ name: '', email: '' }); };
  const deleteContact = (id) => { if (confirm('Delete this contact?')) setContacts(contacts.filter(c => c.id !== id)); };

  const exportTasks = () => {
    const blob = new Blob([JSON.stringify({ tasks, contacts }, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ball-in-court-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const importTasks = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = JSON.parse(ev.target.result);
        if (data.tasks && confirm('Replace current tasks?')) {
          setTasks(data.tasks);
          if (data.contacts) setContacts(data.contacts);
          alert('Imported successfully!');
        }
      } catch { alert('Invalid file.'); }
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  const sendEmail = (task, email) => {
    const subj = encodeURIComponent(`Task: ${task.title}`);
    const body = encodeURIComponent(`Hi,\n\nTask: ${task.title}\nUrgency: ${task.urgency}\nDue: ${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'Not set'}\n\nThanks!`);
    window.location.href = `mailto:${email}?subject=${subj}&body=${body}`;
  };

  const isCompletedToday = (t) => { if (!t.completedDate) return false; const cd = new Date(t.completedDate); cd.setHours(0,0,0,0); return cd.getTime() === getToday().getTime(); };
  const getCompleted = () => tasks.filter(t => t.status === 'completed' && !isCompletedToday(t)).sort((a,b) => new Date(b.completedDate) - new Date(a.completedDate));
  const getBubbleUp = () => { const today = getToday(); return tasks.filter(t => { if (t.status !== 'handed-off' || !t.handoffDate) return false; const days = Math.floor((today - new Date(t.handoffDate)) / 86400000); return days <= 3; }); };
  const getStale = () => { const today = getToday(); return tasks.filter(t => { if (t.status === 'completed') return false; const dd = parseDate(t.dueDate); const fd = parseDate(t.followUpDate); return (dd && Math.floor((today - dd) / 86400000) >= 7) || (fd && Math.floor((today - fd) / 86400000) >= 7); }).sort((a,b) => { const da = parseDate(a.followUpDate || a.dueDate); const db = parseDate(b.followUpDate || b.dueDate); if (!da) return 1; if (!db) return -1; return db - da; }); };
  const getTop = (lim) => { const my = tasks.filter(t => t.owner === 'Me' && (t.status === 'active' || (t.status === 'completed' && isCompletedToday(t)))); const w = { high: 3, medium: 2, low: 1 }; return my.sort((a,b) => { const ud = w[b.urgency] - w[a.urgency]; if (ud !== 0) return ud; const da = parseDate(a.dueDate); const db = parseDate(b.dueDate); if (!da && !db) return 0; if (!da) return 1; if (!db) return -1; return da - db; }).slice(0, lim); };
  
  const getFilteredTasks = () => {
    let filtered = [];
    if (focusedTask) {
      const task = tasks.find(t => t.id === focusedTask);
      return task ? [task] : [];
    }
    if (activeView === 'all') filtered = tasks.filter(t => t.status === 'active');
    else if (activeView === 'top1') filtered = getTop(1);
    else if (activeView === 'top5') filtered = getTop(5);
    else if (activeView === 'bubble') filtered = getBubbleUp();
    else if (activeView === 'stale') filtered = getStale();
    else if (activeView === 'completed') filtered = getCompleted();
    return filtered.sort((a, b) => (a.order || 0) - (b.order || 0));
  };

  const Net = () => (<svg width="32" height="32" viewBox="0 0 32 32" fill="none"><rect x="2" y="14" width="28" height="4" fill="currentColor"/><line x1="4" y1="6" x2="4" y2="26" stroke="currentColor" strokeWidth="1.5"/><line x1="8" y1="6" x2="8" y2="26" stroke="currentColor" strokeWidth="1.5"/><line x1="12" y1="6" x2="12" y2="26" stroke="currentColor" strokeWidth="1.5"/><line x1="16" y1="6" x2="16" y2="26" stroke="currentColor" strokeWidth="1.5"/><line x1="20" y1="6" x2="20" y2="26" stroke="currentColor" strokeWidth="1.5"/><line x1="24" y1="6" x2="24" y2="26" stroke="currentColor" strokeWidth="1.5"/><line x1="28" y1="6" x2="28" y2="26" stroke="currentColor" strokeWidth="1.5"/><line x1="2" y1="10" x2="30" y2="10" stroke="currentColor" strokeWidth="1"/><line x1="2" y1="22" x2="30" y2="22" stroke="currentColor" strokeWidth="1"/></svg>);

  const TaskCard = ({ task, subtaskInputs, setSubtaskInputs }) => {
    const uc = { high: 'from-red-500 to-red-600', medium: 'from-amber-500 to-amber-600', low: 'from-emerald-500 to-emerald-600' };
    const ct = isCompletedToday(task);
    const ic = task.status === 'completed';
    const subtasks = task.subtasks || [];
    const completedSubtasks = subtasks.filter(st => st.completed).length;
    
    const handleSubtaskInputChange = (taskId, value) => {
      setSubtaskInputs({ ...subtaskInputs, [taskId]: value });
    };
    
    const getSubtaskInput = (taskId) => {
      return subtaskInputs[taskId] || '';
    };
    
    return (
      <div 
        draggable={!ic}
        onDragStart={(e) => handleDragStart(e, task)}
        onDragOver={handleDragOver}
        onDrop={(e) => handleDrop(e, task)}
        onDoubleClick={() => setFocusedTask(task.id)}
        className={`bg-white rounded-xl shadow-sm hover:shadow-md transition-all p-5 mb-3 border border-gray-100 ${ct ? 'opacity-70' : ''} ${draggedTask?.id === task.id ? 'opacity-50' : ''} cursor-move`}
      >
        <div className="flex items-start gap-3">
          <div className="text-gray-400 mt-1 cursor-grab active:cursor-grabbing">
            <Icons.Grip />
          </div>
          <div className="flex-1">
            <div className="flex justify-between items-start mb-3">
              <div className="flex-1">
                <h3 className={`font-semibold text-lg ${ct ? 'line-through text-gray-500' : 'text-gray-900'}`}>{task.title}</h3>
                {subtasks.length > 0 && (
                  <div className="text-sm text-gray-600 mt-1">
                    {completedSubtasks}/{subtasks.length} subtasks completed
                  </div>
                )}
              </div>
              {!ic && (<div className="flex gap-2">
                {task.owner === 'Me' && task.status === 'active' && (<><button onClick={() => completeTask(task.id)} className="text-green-600 hover:bg-green-50 p-1.5 rounded-lg" title="Complete"><Icons.Check /></button><button onClick={() => setShowHandoff(task.id)} className="text-blue-600 hover:bg-blue-50 p-1.5 rounded-lg" title="Hand off"><Icons.Send /></button></>)}
                {task.ownerEmail && task.owner !== 'Me' && <button onClick={() => sendEmail(task, task.ownerEmail)} className="text-purple-600 hover:bg-purple-50 p-1.5 rounded-lg" title="Email"><Icons.Mail /></button>}
                <button onClick={() => setShowSubtasks(showSubtasks === task.id ? null : task.id)} className="text-indigo-600 hover:bg-indigo-50 p-1.5 rounded-lg" title="Subtasks">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                </button>
                <button onClick={() => deleteTask(task.id)} className="text-red-600 hover:bg-red-50 p-1.5 rounded-lg" title="Delete"><Icons.Trash /></button>
              </div>)}
              {ic && !ct && <button onClick={() => deleteTask(task.id)} className="text-red-600 hover:bg-red-50 p-1.5 rounded-lg"><Icons.Trash /></button>}
            </div>
            <div className="flex flex-wrap gap-2 text-sm">
              <span className={`px-3 py-1 rounded-full text-white font-medium bg-gradient-to-r ${uc[task.urgency]}`}>{task.urgency[0].toUpperCase() + task.urgency.slice(1)}</span>
              {task.dueDate && <span className="px-3 py-1 bg-gray-100 text-gray-700 rounded-full flex items-center gap-1.5 font-medium"><Icons.Calendar />{new Date(task.dueDate).toLocaleDateString()}</span>}
              <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full flex items-center gap-1.5 font-medium"><Icons.User />{task.owner}</span>
              {task.followUpDate && <span className="px-3 py-1 bg-orange-100 text-orange-700 rounded-full flex items-center gap-1.5 font-medium"><Icons.Clock />Follow: {new Date(task.followUpDate).toLocaleDateString()}</span>}
              {ic && task.completedDate && <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full flex items-center gap-1.5 font-medium"><Icons.Check />{new Date(task.completedDate).toLocaleDateString()}</span>}
            </div>
            
            {showSubtasks === task.id && (
              <div className="mt-4 pt-4 border-t border-gray-200">
                <h4 className="font-semibold text-gray-900 mb-3">Subtasks</h4>
                <div className="space-y-2 mb-3">
                  {subtasks.map(st => (
                    <div 
                      key={st.id} 
                      className="flex items-center gap-2 p-2 bg-gray-50 rounded-lg"
                    >
                      <input 
                        type="checkbox" 
                        checked={st.completed} 
                        onChange={() => toggleSubtask(task.id, st.id)}
                        className="w-4 h-4 text-blue-600 rounded"
                      />
                      <span className={`flex-1 text-sm ${st.completed ? 'line-through text-gray-500' : 'text-gray-900'}`}>{st.title}</span>
                      <button 
                        onClick={() => promoteSubtask(task.id, st)}
                        className="text-blue-600 hover:bg-blue-50 p-1 rounded text-xs"
                        title="Promote to full task"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"/></svg>
                      </button>
                      <button 
                        onClick={() => deleteSubtask(task.id, st.id)}
                        className="text-red-600 hover:bg-red-50 p-1 rounded"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                      </button>
                    </div>
                  ))}
                </div>
                <div className="flex gap-2">
                  <input 
                    type="text" 
                    value={getSubtaskInput(task.id)}
                    onChange={(e) => handleSubtaskInputChange(task.id, e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && addSubtask(task.id)}
                    placeholder="Add subtask..."
                    className="flex-1 border-2 border-gray-200 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:outline-none"
                  />
                  <button 
                    onClick={() => addSubtask(task.id)}
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700"
                  >
                    Add
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };

  const HandoffModal = ({ task }) => {
    const [data, setData] = useState({ owner: '', ownerEmail: '', urgency: task.urgency, dueDate: task.dueDate, followUpDate: addDays(getToday(), 2).toISOString().split('T')[0], sendEmail: false });
    const [custom, setCustom] = useState(false);
    const sel = (c) => { setData({ ...data, owner: c.name, ownerEmail: c.email }); setCustom(false); };
    const submit = () => { handleHandoff(task.id, data); if (data.sendEmail && data.ownerEmail) setTimeout(() => sendEmail({ ...task, ...data }, data.ownerEmail), 100); };
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl my-8">
          <h3 className="text-2xl font-bold mb-6">Hand Off Task</h3>
          <div className="space-y-4">
            {!custom ? (<div><div className="flex justify-between mb-2"><label className="text-sm font-semibold">Select Contact:</label><button onClick={() => setCustom(true)} className="text-xs text-blue-600">Custom name</button></div>{contacts.length > 0 ? (<div className="space-y-2 max-h-48 overflow-y-auto border rounded-xl p-2">{contacts.map(c => <button key={c.id} onClick={() => sel(c)} className={`w-full text-left px-4 py-3 rounded-lg ${data.owner === c.name ? 'bg-blue-100 border-2 border-blue-500' : 'bg-gray-50 hover:bg-gray-100 border-2 border-transparent'}`}><div className="font-semibold">{c.name}</div>{c.email && <div className="text-sm text-gray-600">{c.email}</div>}</button>)}</div>) : (<div className="text-center py-4 text-gray-500 text-sm border rounded-xl">No contacts. Add in Settings.</div>)}</div>) : (<div><div className="flex justify-between mb-2"><label className="text-sm font-semibold">Custom Name:</label><button onClick={() => setCustom(false)} className="text-xs text-blue-600">Select contact</button></div><input type="text" value={data.owner} onChange={e => setData({...data, owner: e.target.value})} className="w-full border-2 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:outline-none" placeholder="Name" /><input type="email" value={data.ownerEmail} onChange={e => setData({...data, ownerEmail: e.target.value})} className="w-full border-2 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:outline-none mt-2" placeholder="Email" /></div>)}
            <div><label className="block text-sm font-semibold mb-2">Urgency:</label><select value={data.urgency} onChange={e => setData({...data, urgency: e.target.value})} className="w-full border-2 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:outline-none"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select></div>
            <div><label className="block text-sm font-semibold mb-2">Due Date:</label><input type="date" value={data.dueDate} onChange={e => setData({...data, dueDate: e.target.value})} className="w-full border-2 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:outline-none" /></div>
            <div><label className="block text-sm font-semibold mb-2">Follow Up:</label><input type="date" value={data.followUpDate} onChange={e => setData({...data, followUpDate: e.target.value})} className="w-full border-2 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:outline-none" /></div>
            {data.ownerEmail && <div className="flex items-center gap-2"><input type="checkbox" id="se" checked={data.sendEmail} onChange={e => setData({...data, sendEmail: e.target.checked})} className="w-4 h-4" /><label htmlFor="se" className="text-sm font-medium">Send email</label></div>}
          </div>
          <div className="flex gap-3 mt-6">
            <button onClick={submit} disabled={!data.owner.trim()} className="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-xl font-semibold disabled:opacity-50">Hand Off</button>
            <button onClick={() => setShowHandoff(null)} className="flex-1 bg-gray-100 text-gray-700 px-6 py-3 rounded-xl font-semibold">Cancel</button>
          </div>
        </div>
      </div>
    );
  };

  const ContactMgr = () => (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
      <div className="bg-white rounded-2xl p-6 w-full max-w-2xl shadow-2xl my-8">
        <h3 className="text-2xl font-bold mb-6">Manage Contacts</h3>
        <div className="mb-6 bg-gray-50 rounded-xl p-4">
          <h4 className="font-semibold mb-3">Add Contact</h4>
          <div className="flex gap-2">
            <input type="text" value={newContact.name} onChange={e => setNewContact({...newContact, name: e.target.value})} className="flex-1 border-2 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:outline-none" placeholder="Name" />
            <input type="email" value={newContact.email} onChange={e => setNewContact({...newContact, email: e.target.value})} className="flex-1 border-2 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:outline-none" placeholder="Email" />
            <button onClick={addContact} disabled={!newContact.name.trim()} className="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-2.5 rounded-xl font-semibold"><Icons.UserPlus /></button>
          </div>
        </div>
        <div className="mb-6">
          <h4 className="font-semibold mb-3">Contacts ({contacts.length})</h4>
          {contacts.length > 0 ? (<div className="space-y-2 max-h-96 overflow-y-auto">{contacts.map(c => <div key={c.id} className="flex justify-between items-center bg-white border rounded-xl p-4"><div><div className="font-semibold">{c.name}</div>{c.email && <div className="text-sm text-gray-600">{c.email}</div>}</div><button onClick={() => deleteContact(c.id)} className="text-red-600 hover:bg-red-50 p-2 rounded-lg"><Icons.Trash /></button></div>)}</div>) : (<div className="text-center py-8 text-gray-500">No contacts yet!</div>)}
        </div>
        <button onClick={() => setShowContactManager(false)} className="w-full bg-gray-100 text-gray-700 px-6 py-3 rounded-xl font-semibold">Close</button>
      </div>
    </div>
  );

  const SettingsMod = () => (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
      <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl my-8">
        <h3 className="text-2xl font-bold mb-6">Settings</h3>
        <div className="space-y-4">
          <button onClick={() => { setShowSettings(false); setShowContactManager(true); }} className="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white px-6 py-3 rounded-xl font-semibold flex items-center justify-center gap-2"><Icons.Users />Manage Contacts</button>
          <button onClick={exportTasks} className="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-xl font-semibold flex items-center justify-center gap-2"><Icons.Download />Export</button>
          <label className="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 cursor-pointer"><Icons.Upload />Import<input type="file" accept=".json" onChange={importTasks} className="hidden" /></label>
        </div>
        <button onClick={() => setShowSettings(false)} className="w-full bg-gray-100 text-gray-700 px-6 py-3 rounded-xl font-semibold mt-4">Close</button>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 pb-24">
      <div className="container mx-auto px-4 py-8 max-w-4xl">
        <header className="mb-8">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="text-indigo-600"><Net /></div>
              <div><h1 className="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-blue-600 bg-clip-text text-transparent">Ball-in-Court</h1><p className="text-gray-600 font-medium">Track whose court the ball is in</p></div>
            </div>
            <button onClick={() => setShowSettings(true)} className="text-gray-600 hover:bg-gray-100 p-2 rounded-lg" title="Settings"><Icons.Settings /></button>
          </div>
        </header>

        <button onClick={() => setShowAddTask(true)} className="mb-6 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-xl font-semibold flex items-center gap-2 shadow-lg shadow-green-500/30"><Icons.Plus />Add Task</button>

        {focusedTask && (
          <div className="mb-6 flex items-center gap-2">
            <button 
              onClick={() => setFocusedTask(null)} 
              className="bg-gray-600 text-white px-4 py-2 rounded-xl font-medium hover:bg-gray-700 flex items-center gap-2"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6"/></svg>
              All Tasks
            </button>
            <span className="text-gray-600 font-medium">Focused on: {tasks.find(t => t.id === focusedTask)?.title}</span>
          </div>
        )}

        {showAddTask && (
          <div className="bg-white rounded-2xl shadow-xl p-6 mb-6 border">
            <h2 className="text-2xl font-bold mb-6">New Task</h2>
            <div className="space-y-4">
              <div><label className="block text-sm font-semibold mb-2">Title:</label><input type="text" value={newTask.title} onChange={e => setNewTask({...newTask, title: e.target.value})} className="w-full border-2 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:outline-none" placeholder="Task" /></div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div><label className="block text-sm font-semibold mb-2">Due:</label><input type="date" value={newTask.dueDate} onChange={e => setNewTask({...newTask, dueDate: e.target.value})} className="w-full border-2 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:outline-none" /></div>
                <div><label className="block text-sm font-semibold mb-2">Urgency:</label><select value={newTask.urgency} onChange={e => setNewTask({...newTask, urgency: e.target.value})} className="w-full border-2 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:outline-none"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select></div>
                <div><label className="block text-sm font-semibold mb-2">Owner:</label><input type="text" value={newTask.owner} onChange={e => setNewTask({...newTask, owner: e.target.value})} className="w-full border-2 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:outline-none" placeholder="Me" /></div>
              </div>
              <div className="flex gap-3">
                <button onClick={handleAddTask} className="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-2.5 rounded-xl font-semibold">Add</button>
                <button onClick={() => { setShowAddTask(false); setNewTask({ title: '', dueDate: '', urgency: 'medium', owner: 'Me' }); }} className="bg-gray-100 text-gray-700 px-6 py-2.5 rounded-xl font-semibold">Cancel</button>
              </div>
            </div>
          </div>
        )}

        <div className="bg-white rounded-2xl shadow-xl p-6 border min-h-96">
          {focusedTask ? (
            <>
              <h2 className="text-2xl font-bold mb-6">Focus Mode</h2>
              {getFilteredTasks().map(t => <TaskCard key={t.id} task={t} subtaskInputs={subtaskInputs} setSubtaskInputs={setSubtaskInputs} />)}
            </>
          ) : (
            <>
              {activeView === 'all' && (<><h2 className="text-2xl font-bold mb-6">All Active Tasks</h2>{getFilteredTasks().length === 0 ? (<div className="text-center py-12"><div className="text-gray-300 mb-4 flex justify-center"><Icons.List /></div><p className="text-gray-500 font-medium">No tasks. Add one!</p></div>) : (getFilteredTasks().map(t => <TaskCard key={t.id} task={t} subtaskInputs={subtaskInputs} setSubtaskInputs={setSubtaskInputs} />))}</>)}
              {activeView === 'top1' && (<><h2 className="text-2xl font-bold mb-6">Top Priority</h2>{getFilteredTasks().length === 0 ? (<div className="text-center py-12"><div className="text-gray-300 mb-4 flex justify-center"><Icons.Flame /></div><p className="text-gray-500 font-medium">No tasks!</p></div>) : (getFilteredTasks().map(t => <TaskCard key={t.id} task={t} subtaskInputs={subtaskInputs} setSubtaskInputs={setSubtaskInputs} />))}</>)}
              {activeView === 'top5' && (<><h2 className="text-2xl font-bold mb-6">Top 5 Priorities</h2>{getFilteredTasks().length === 0 ? (<div className="text-center py-12"><div className="text-gray-300 mb-4 flex justify-center"><Icons.TrendUp /></div><p className="text-gray-500 font-medium">No tasks!</p></div>) : (getFilteredTasks().map(t => <TaskCard key={t.id} task={t} subtaskInputs={subtaskInputs} setSubtaskInputs={setSubtaskInputs} />))}</>)}
              {activeView === 'bubble' && (<><h2 className="text-2xl font-bold mb-6">Bubble Up Tasks</h2><p className="text-sm text-gray-600 mb-4 font-medium">Handed off in last 3 days</p>{getFilteredTasks().length === 0 ? (<div className="text-center py-12"><div className="text-gray-300 mb-4 flex justify-center"><Icons.TrendUp /></div><p className="text-gray-500 font-medium">No bubble up tasks</p></div>) : (getFilteredTasks().map(t => <TaskCard key={t.id} task={t} subtaskInputs={subtaskInputs} setSubtaskInputs={setSubtaskInputs} />))}</>)}
              {activeView === 'stale' && (<><h2 className="text-2xl font-bold mb-6">Stale Tasks</h2><p className="text-sm text-gray-600 mb-4 font-medium">7+ days overdue</p>{getFilteredTasks().length === 0 ? (<div className="text-center py-12"><div className="text-gray-300 mb-4 flex justify-center"><Icons.Alert /></div><p className="text-gray-500 font-medium">No stale tasks</p></div>) : (getFilteredTasks().map(t => <TaskCard key={t.id} task={t} subtaskInputs={subtaskInputs} setSubtaskInputs={setSubtaskInputs} />))}</>)}
              {activeView === 'completed' && (<><h2 className="text-2xl font-bold mb-6">Completed Tasks</h2><p className="text-sm text-gray-600 mb-4 font-medium">Yesterday or earlier</p>{getFilteredTasks().length === 0 ? (<div className="text-center py-12"><div className="text-gray-300 mb-4 flex justify-center"><Icons.Archive /></div><p className="text-gray-500 font-medium">No completed tasks</p></div>) : (getFilteredTasks().map(t => <TaskCard key={t.id} task={t} subtaskInputs={subtaskInputs} setSubtaskInputs={setSubtaskInputs} />))}</>)}
            </>
          )}
        </div>
      </div>

      <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
        <div className="container mx-auto px-4 max-w-4xl">
          <div className="flex justify-around items-center py-2">
            <button onClick={() => setActiveView('all')} className={`flex flex-col items-center py-2 px-3 rounded-lg ${activeView === 'all' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-50'}`}><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg><span className="text-xs font-semibold mt-1">All</span></button>
            <button onClick={() => setActiveView('top1')} className={`flex flex-col items-center py-2 px-3 rounded-lg ${activeView === 'top1' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-50'}`}><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg><span className="text-xs font-semibold mt-1">Top 1</span></button>
            <button onClick={() => setActiveView('top5')} className={`flex flex-col items-center py-2 px-3 rounded-lg ${activeView === 'top5' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-50'}`}><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg><span className="text-xs font-semibold mt-1">Top 5</span></button>
            <button onClick={() => setActiveView('bubble')} className={`flex flex-col items-center py-2 px-3 rounded-lg ${activeView === 'bubble' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-50'}`}><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span className="text-xs font-semibold mt-1">Bubble</span></button>
            <button onClick={() => setActiveView('stale')} className={`flex flex-col items-center py-2 px-3 rounded-lg ${activeView === 'stale' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-50'}`}><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span className="text-xs font-semibold mt-1">Stale</span></button>
            <button onClick={() => setActiveView('completed')} className={`flex flex-col items-center py-2 px-3 rounded-lg ${activeView === 'completed' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-50'}`}><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span className="text-xs font-semibold mt-1">Done</span></button>
          </div>
        </div>
      </div>

      {showHandoff && <HandoffModal task={tasks.find(t => t.id === showHandoff)} />}
      {showSettings && <SettingsMod />}
      {showContactManager && <ContactMgr />}
    </div>
  );
};

ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
